<?xml version="1.0" encoding="UTF-8"?>
<svg
  xmlns="http://www.w3.org/2000/svg"
  width="1600"
  height="900"
  viewBox="0 0 1600 900"
  role="img"
  aria-label="Remote MCP server architecture without and with Code Mode on Cloudflare Workers"
>
  <defs>
    <marker id="arrowGrey" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="10" markerHeight="10" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#6b7280" />
    </marker>
    <marker id="arrowOrange" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="10" markerHeight="10" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#f38020" />
    </marker>
    <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="2" stdDeviation="6" flood-color="#111827" flood-opacity="0.10" />
    </filter>
    <style>
      .canvas { fill: #ffffff; }
      .title { font: 700 24px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #111827; }
      .subtitle { font: 400 14px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #4b5563; }
      .panel { fill: #f7f8fb; stroke: #e5e7eb; stroke-width: 1.5; }
      .panelTitle { font: 700 18px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #111827; }
      .panelNote { font: 400 12px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #6b7280; }
      .box { fill: #ffffff; stroke: #cfd6e4; stroke-width: 1.5; }
      .boxCF { fill: #fff7ed; stroke: #f38020; stroke-width: 1.8; }
      .boxExt { fill: #f3f4f6; stroke: #cfd6e4; stroke-width: 1.5; }
      .boxTitle { font: 700 16px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #111827; }
      .boxText { font: 400 12.5px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #374151; }
      .mono { font: 500 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; fill: #374151; }
      .tag { fill: #ffffff; stroke: #f38020; stroke-width: 1.2; }
      .tagText { font: 700 11px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #b45309; letter-spacing: 0.3px; }
      .arrow { stroke: #6b7280; stroke-width: 2.2; fill: none; }
      .arrowOrange { stroke: #f38020; stroke-width: 2.6; fill: none; }
      .arrowOrangeDashed { stroke: #f38020; stroke-width: 2.6; fill: none; stroke-dasharray: 7 6; }
      .arrowLabel { font: 500 11.5px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #6b7280; }
      .arrowLabelOrange { font: 600 11.5px/1.2 Overpass, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; fill: #b45309; }
    </style>
  </defs>

  <rect class="canvas" x="0" y="0" width="1600" height="900" />

  <text class="title" x="800" y="56" text-anchor="middle">Remote MCP Server Extensions on Cloudflare Workers</text>
  <text class="subtitle" x="800" y="84" text-anchor="middle">Direct tool calls (no Code Mode) vs isolate execution (Code Mode)</text>

  <!-- Panels -->
  <rect class="panel" x="60" y="110" width="720" height="740" rx="28" />
  <rect class="panel" x="820" y="110" width="720" height="740" rx="28" />

  <text class="panelTitle" x="90" y="150">Without Code Mode</text>
  <text class="panelNote" x="90" y="174">MCP client calls tools directly over /mcp</text>

  <text class="panelTitle" x="850" y="150">With Code Mode</text>
  <text class="panelNote" x="850" y="174">execute_code runs JS in a V8 isolate; tool calls loop back via a proxy</text>

  <!-- Left panel boxes -->
  <g filter="url(#softShadow)">
    <rect class="box" x="140" y="190" width="560" height="80" rx="18" />
    <rect class="boxCF" x="140" y="320" width="560" height="80" rx="18" />
    <rect class="boxCF" x="140" y="450" width="560" height="120" rx="18" />
    <rect class="boxExt" x="140" y="620" width="560" height="150" rx="18" />
  </g>

  <text class="boxTitle" x="164" y="222">MCP Client</text>
  <text class="boxText" x="164" y="246">Claude Desktop, Inspector, custom apps</text>

  <text class="boxTitle" x="164" y="352">Cloudflare Worker</text>
  <text class="boxText" x="164" y="376">HTTP router exposing Streamable HTTP endpoint: <tspan class="mono">/mcp</tspan></text>

  <text class="boxTitle" x="164" y="482">Durable Object: MyMCP</text>
  <text class="boxText" x="164" y="506">McpAgent + ToolRegistry (registers tools, dispatches calls, generates types)</text>
  <rect class="tag" x="164" y="526" width="112" height="22" rx="11" />
  <text class="tagText" x="220" y="542" text-anchor="middle">CORE SERVER</text>

  <text class="boxTitle" x="164" y="652">Extension: SQLite-in-DO</text>
  <text class="boxText" x="164" y="676">Per-instance embedded SQLite database (up to 10GB)</text>
  <text class="boxText" x="164" y="700">Exposed as tools:</text>
  <text class="mono" x="164" y="724">sql_query  sql_exec  sql_exec_batch</text>

  <!-- Left panel arrows -->
  <path class="arrow" d="M 420 270 L 420 320" marker-end="url(#arrowGrey)" />
  <text class="arrowLabel" x="432" y="302">Streamable HTTP (<tspan class="mono">/mcp</tspan>)</text>

  <path class="arrow" d="M 420 400 L 420 450" marker-end="url(#arrowGrey)" />
  <text class="arrowLabel" x="432" y="432">Routes to Durable Object</text>

  <path class="arrow" d="M 420 570 L 420 620" marker-end="url(#arrowGrey)" />
  <text class="arrowLabel" x="432" y="602">Tool calls (<tspan class="mono">sql_*</tspan>)</text>

  <!-- Right panel boxes -->
  <g filter="url(#softShadow)">
    <!-- Left lane -->
    <rect class="box" x="850" y="190" width="360" height="80" rx="18" />
    <rect class="boxCF" x="850" y="320" width="360" height="80" rx="18" />
    <rect class="boxCF" x="850" y="450" width="360" height="140" rx="18" />
    <rect class="boxExt" x="850" y="650" width="360" height="120" rx="18" />

    <!-- Right lane -->
    <rect class="boxExt" x="1240" y="450" width="270" height="90" rx="18" />
    <rect class="boxExt" x="1240" y="570" width="270" height="70" rx="18" />
    <rect class="boxExt" x="1240" y="670" width="270" height="120" rx="18" />
  </g>

  <!-- Right panel: left lane text -->
  <text class="boxTitle" x="874" y="222">MCP Client</text>
  <text class="boxText" x="874" y="246">Same MCP connection as left</text>

  <text class="boxTitle" x="874" y="352">Cloudflare Worker</text>
  <text class="boxText" x="874" y="376">Routes <tspan class="mono">/mcp</tspan> traffic to a Durable Object instance</text>

  <text class="boxTitle" x="874" y="482">Durable Object: MyMCP</text>
  <text class="boxText" x="874" y="506">ToolRegistry + extensions</text>
  <text class="boxText" x="874" y="530">1. Direct tool calls (SQL, etc.)</text>
  <text class="boxText" x="874" y="554">2. Code Mode tools that launch an isolate</text>

  <text class="boxTitle" x="874" y="682">Extension: SQLite-in-DO</text>
  <text class="mono" x="874" y="706">sql_query  sql_exec  sql_exec_batch</text>
  <text class="boxText" x="874" y="730">Shared by both direct calls and Code Mode calls</text>

  <!-- Right panel: right lane text -->
  <text class="boxTitle" x="1264" y="482">Extension: Code Mode</text>
  <text class="mono" x="1264" y="506">get_type_schema</text>
  <text class="mono" x="1264" y="528">execute_code</text>

  <text class="boxTitle" x="1264" y="600">Worker Loader</text>
  <text class="boxText" x="1264" y="624"><tspan class="mono">LOADER</tspan> binding (optional beta)</text>

  <text class="boxTitle" x="1264" y="702">V8 Isolate (sandboxed)</text>
  <text class="boxText" x="1264" y="726">Runs user-provided JS</text>
  <text class="boxText" x="1264" y="750">Calls tools via <tspan class="mono">codemode.*</tspan></text>

  <!-- Right panel arrows: base connection -->
  <path class="arrow" d="M 1030 270 L 1030 320" marker-end="url(#arrowGrey)" />
  <text class="arrowLabel" x="1042" y="302">Streamable HTTP (<tspan class="mono">/mcp</tspan>)</text>

  <path class="arrow" d="M 1030 400 L 1030 450" marker-end="url(#arrowGrey)" />
  <text class="arrowLabel" x="1042" y="432">Routes to Durable Object</text>

  <path class="arrow" d="M 1030 590 L 1030 650" marker-end="url(#arrowGrey)" />
  <text class="arrowLabel" x="1042" y="626">Direct tool calls (<tspan class="mono">sql_*</tspan>)</text>

  <!-- Right panel arrows: Code Mode path -->
  <path class="arrowOrange" d="M 1210 500 L 1234 500" marker-end="url(#arrowOrange)" />
  <text class="arrowLabelOrange" x="1220" y="488">execute_code</text>

  <path class="arrowOrange" d="M 1375 540 L 1375 570" marker-end="url(#arrowOrange)" />
  <text class="arrowLabelOrange" x="1387" y="564">spins up isolate</text>

  <path class="arrowOrange" d="M 1375 640 L 1375 670" marker-end="url(#arrowOrange)" />

  <!-- Return path: isolate tool calls route back into ToolRegistry -->
  <path
    class="arrowOrangeDashed"
    d="M 1510 730 C 1530 730 1530 560 1210 560"
    marker-end="url(#arrowOrange)"
  />
  <text class="arrowLabelOrange" x="1264" y="822">codemode.* calls route back via CODE_MODE_PROXY</text>
  <text class="arrowLabelOrange" x="1264" y="840">and are dispatched by ToolRegistry (callTool())</text>
</svg>
